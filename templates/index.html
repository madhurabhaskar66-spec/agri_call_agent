<!DOCTYPE html>
<html>

<head>
    <title>ðŸŒ¾ Agriculture Voice Assistant</title>
</head>

<body>

    <h2>ðŸŒ¾ Agriculture Voice Assistant</h2>

    <button onclick="startListening()">ðŸŽ¤ Speak</button>

    <p><b>You:</b> <span id="userText"></span></p>
    <p><b>AI:</b> <span id="response"></span></p>

    <script>

        // ðŸ”Š TEXT TO SPEECH (Output Voice)
        function speak(text, lang = "en-US") {
            window.speechSynthesis.cancel();

            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = lang;
            speech.pitch = 1.3;
            speech.rate = 1;

            window.speechSynthesis.speak(speech);
        }


        // ðŸŽ¤ SPEECH TO TEXT (Input Voice)
        function startListening() {

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

            recognition.lang = navigator.language || "en-US";   // Uses device's default language for multi-lingual input
            recognition.interimResults = false;

            recognition.start();

            recognition.onresult = async function (event) {

                const userSpeech = event.results[0][0].transcript;

                document.getElementById("userText").innerText = userSpeech;

                // Send to backend
                const response = await fetch("http://127.0.0.1:8000/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ message: userSpeech })
                });

                const data = await response.json();

                let replyText = data.reply;
                let langCode = navigator.language || "en-US";

                // Extract language code if AI provides it (e.g., [hi-IN])
                const langMatch = replyText.match(/^\[([a-zA-Z]{2}-[a-zA-Z]{2,4})\]/);
                if (langMatch) {
                    langCode = langMatch[1];
                    replyText = replyText.substring(langMatch[0].length).trim();
                }

                document.getElementById("response").innerText = replyText;

                // Speak response
                speak(replyText, langCode);
            };
        }

    </script>

</body>

</html>